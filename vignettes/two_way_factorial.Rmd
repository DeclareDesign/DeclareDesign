---
title: "Two-Way Factorial Experiment"
output: rmarkdown::html_vignette
bibliography: bib.bib
vignette: >
  %\VignetteIndexEntry{Two-Way Factorial Experiment}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---



```{r MIDA, echo = FALSE,include = FALSE}
library(DeclareDesign)
library(dplyr)
library(ggplot2)

two_way_factorial_template <- function(N = c(30, 100, 500, 1000),
                             beta_A = c(1, -1, 0),
                             beta_B = c(-1, 0, 1),
                             beta_AB = c(.5, -1, -.5, 0, 1))
{
  N <- as.numeric(N[1])
  beta_A <- as.numeric(beta_A[1])
  beta_B <- as.numeric(beta_B[1])
  beta_AB <- as.numeric(beta_AB[1])

  # Model ------------------------------------------------------------------------
  population <- declare_population(N = N, noise = rnorm(N))
  
  potential_outcomes <- declare_potential_outcomes(
    Y_Z_T1 = noise,
    Y_Z_T2 = noise + beta_A,
    Y_Z_T3 = noise + beta_B,
    Y_Z_T4 = noise + beta_A + beta_B + beta_AB)
  
  # Inquiry ----------------------------------------------------------------------
  estimand <- declare_estimand(
    interaction = mean((Y_Z_T4 - Y_Z_T3) - (Y_Z_T2 - Y_Z_T1)), 
    label = "interaction")
  
  # Data Strategy ----------------------------------------------------------------
  assignment <- declare_assignment(num_arms = 4)
  
  # Answer Strategy --------------------------------------------------------------
  estimator <- declare_estimator(Y ~ A + B + A:B,
                                 model = lm_robust,
                                 coefficient_name = "A:B", 
                                 estimand = estimand)
  
  # Design -----------------------------------------------------------------------
  design <- declare_design(
    population,
    potential_outcomes,
    estimand,
    assignment,
    dplyr::mutate(A = as.numeric(Z %in% c("T2", "T4")),
                  B = as.numeric(Z %in% c("T3", "T4"))),
    reveal_outcomes,
    estimator, 
    citation = utils::bibentry(bibtype = "Article",
                                title = "A factorial experiment in teachersâ€™ written feedback on student homework: Changing teacher behavior a little rather than a lot.",
                                author= "Elawar, Maria C., and Lyn Corno.",
                                journal= "Journal of educational psychology",
                                volume = "77.2",
                                year = "1985",
                                page = 162)
    )
  
  design
}
attr(two_way_factorial_template, "tips") <- c(
  "N" = "Size of population",
  "beta_A" = "Main effect of A",
  "beta_B" = "Main effect of B",
  "beta_AB" = "Interaction effect of A and B"
)
attr(two_way_factorial_template, "description") <- "
<p> A two way factorial design with a size <code>N</code>, 
    main effects <code>beta_A</code> and <code>beta_B</code>, 
    and interaction <code>beta_AB</code>. 

<p> Estimand is the average interaction effect.
"
```


<div class="btn-group">
  <a class="btn btn-primary" href="http://declaredesign.org/articles/two_way_factorial.R">
    <i class="fa fa-code" title = "Download code for design" fa-2x></i> Download code
  </a>
  <a class="btn btn-primary" href="http://declaredesign.org/articles/two_way_factorial_template.RDS">
    <i class="fa fa-clipboard" title = "Download template for design" fa-2x></i> Download template
  </a>
<!--
  <a class="btn btn-primary" href="http://shiny.declaredesign.org/inspector/?topic=two_way_factorial">
    <i class="fa fa-area-chart" title = "Go to the design inspector" fa-2x></i> Inspect design
  </a>
-->
</div>


Often we wish to know whether the effect of some causal factor increases or decreases in the presence of another causal factor. For example, when seeking to increase voter turnout, is the effect of phone calls larger or smaller when voters have already received mail bearing the same message? If the message is made more convincing through repetition then we may expect phone calls increase turnout more effectively when voters have already received mail. However, a phone call might also be less effective when someone has already received mail, because the person becomes over-saturated with messages (@green2013field). 

When the effect of $A$ is bigger in the presence of $B$ we call this a positive interaction, and when it is smaller in the presence of $B$ we call it a negative interaction. Note that the direction of the interaction depends on the difference in the effects. Suppose, for example, that the effect of $A$ when $B$ is absent is -10 and when $B$ is present it is -7. Even though these effects are negative, the interaction is positive because the presence of $B$ increases the effect of $A$ by 3. 

The most straightforward way to investigate interactions is through the two-way factorial design. Participants in a study are assigned -- usually in equal proportions -- to one of four conditions: 1) neither $A$ nor $B$; 2) $A$ only; 3) $B$ only; or, 4) both $A$ and $B$. Those assigned to condition 1 don't receive any effects, those assigned to 2 experience the effects of $A$ only, those assigned to 3 receive the effects of $B$ only, and those assigned to 4 receive both the effects of $A$ and $B$, as well as whatever extra effect the combination of $A$ and $B$ produce (the interaction). To isolate the interaction, we must firstly use the groups 1 and 2 to estimate the 'pure' effect of $A$ and groups 1 and 3 to estimate the 'pure' effect of $B$. When we subtract these two estimates from group 4, we are left with the interaction. 

As may be clear from this description, however, estimating all of these quantities at once requires a lot of data to achieve statistical precision. Exactly how big does a researcher's design have to be in order to have at least 80\% probability of rejecting the null hypothesis of no effect for a given effect size? This is a surprisingly difficult question to answer, because answering it accurately depends upon the specific model of the potential outcomes the researcher has in mind. As a result, many researchers use rules of thumb that may lead to systematic over- or under-confidence. Using the MIDA framework and design simulation, however, we can provide a flexible answer to this question that does not rely on rules of thumb. 

## Design Declaration

- **M**odel: 

    We specify a population of $N$ study participants, each of whom has four potential outcomes corresponding to the 4 conditions to which they could be assigned, as enumerated previously. When they are in the first condition, their outcome $Y_0$ is standard normally distributed baseline noise. In the second, the potential outcome $Y_A$ is their baseline plus the effect of $A$, and in the third $Y_B$ is their baseline plus the effect of $B$. In the fourth condition they reveal the potential outcome $Y_{AB}$, receiving the $A$ and $B$ effects, as well as the supplementary effect produced by the combination of $A$ and $B$ -- the interaction. In our simulations below we set $N = 1000$, $\beta_A = \beta_B = 0$ and $\beta_{AB} = .25$. This amounts to an assumption that both causes must be present in order to produce an effect, and that the effect thereby produced is equal to a quarter of a standard deviation in the outcome.

- **I**nquiry: 

    We wish to know the true average interaction, $\beta_{AB}$. Note $Y_{AB} - Y_B = \beta_{AB} + \beta_A$, and $Y_{A} - Y_{0} = \beta_A$. Thus, the expected difference of these terms is equal to the interaction: $E[(Y_{AB} - Y_B) - (Y_A - Y_0)] = \beta_{AB}$.  

- **D**ata strategy: 
    
    We assign equal proportions of the participants to each of the four combinations of treatment. 

- **A**nswer strategy: 
    
    We estimate the interaction by regressing the outcome on indicators for the two treatments and their interaction.


```{r}
# Set design parameters --------------------------------------------------------
N <- 1000
beta_A <- 0
beta_B <- 0
beta_AB <- .25

# Model ------------------------------------------------------------------------
population <- declare_population(N = N, noise = rnorm(N))

potential_outcomes <- declare_potential_outcomes(
  Y_Z_T1 = noise,
  Y_Z_T2 = noise + beta_A,
  Y_Z_T3 = noise + beta_B,
  Y_Z_T4 = noise + beta_A + beta_B + beta_AB)

# Inquiry ----------------------------------------------------------------------
estimand <- declare_estimand(
  interaction = mean((Y_Z_T4 - Y_Z_T3) - (Y_Z_T2 - Y_Z_T1)), 
  label = "interaction")

# Data Strategy ----------------------------------------------------------------
assignment <- declare_assignment(num_arms = 4)

# Answer Strategy --------------------------------------------------------------
estimator <- declare_estimator(Y ~ A + B + A:B,
                               model = lm_robust,
                               coefficient_name = "A:B", 
                               estimand = estimand)

# Design -----------------------------------------------------------------------
design <- declare_design(
  population,
  potential_outcomes,
  estimand,
  assignment,
  dplyr::mutate(A = as.numeric(Z %in% c("T2", "T4")),
                B = as.numeric(Z %in% c("T3", "T4"))),
  reveal_outcomes,
  estimator)
```


## Takeaways 

With the design declared we can run a diagnosis from Monte Carlo simulations of the design:

```{r,eval = FALSE, echo = FALSE}
designs <- fill_out(two_way_factorial_template,
                        N = seq(150,3000,150),  
                        beta_A = 0,
                        beta_B = 0,
                        beta_AB = .25)
diagnoses_N <- diagnose_design(designs, sims = 1000, bootstrap = FALSE)
diagnosis <- diagnose_design(design, sims = 10000, bootstrap_sims = 1000)
saveRDS(diagnoses_N,"two_way_factorial_diagnoses_N.RDS")
saveRDS(diagnosis,"two_way_factorial_diagnosis.RDS")
```

```{r,eval = FALSE, echo = TRUE}
diagnosis <- diagnose_design(design, sims = 10000, bootstrap_sims = 1000)
```

```{r,echo = FALSE}
if(file.exists("two_way_factorial_diagnosis.RDS")) diagnosis <- readRDS("two_way_factorial_diagnosis.RDS")
if(file.exists("two_way_factorial_diagnoses_N.RDS")) diagnoses_N <- readRDS("two_way_factorial_diagnoses_N.RDS")
if(exists("diagnosis")) {
  cols <- c("Mean Estimate"="mean_estimate",
           "Mean Estimand"="mean_estimand",
           "Bias"="bias",
           "SE(bias)"="se(bias)",
           "Power"="power",
           "SE(Power)"="se(power)",
           "Coverage"="coverage",
           "SE(Coverage)"="se(coverage)"
  )
  diagnosis_table <- get_diagnosands(diagnosis)[cols]
  diagnosands <- get_diagnosands(diagnosis)
  names(diagnosis_table) <- names(cols)
  
  mean_estimate <- round(diagnosands[1,"mean_estimate"],3)
  mean_estimand <- round(diagnosands[1,"mean_estimand"],3)
  bias <- round(diagnosands[1,"bias"],3)
  power <- round(diagnosands[1,"power"],2)*100
  coverage <- round(diagnosands[1,"coverage"],2)*100
  
  knitr::kable(diagnosis_table,digits = 3)
}
```

The first thing to note about the design is that it produces an unbiased estimate of the quantity we care about: the average estimate is equal to the average estimand, at `r mean_estimate`. The design exhibits good coverage too, with the estimand falling within the estimated confidence intervals roughly `r coverage`% of the time.
  
Note, however, that the power of this design is very low. Even with 1000 subjects, at `r power`% power, whether or not we detect the reasonably large one-quarter standard deviation effect is essentially a coin toss. Half of the time we run the risk of erroneously maintaining a null of no effect, whereas in combination the treatments do in fact produce a fairly large effect.
  
We can use the design template `two_way_factorial_template` to quickly declare an array of designs that increment the $N$ from 150 to 3,000 by increments of 150. Diagnosing and plotting the results of this exercise reveals that we would require over 2,000 respondents to reach statistical power at the conventional 80% level.


```{r,eval = FALSE, echo = TRUE}
designs <- fill_out(two_way_factorial_template,
                        N = seq(150,3000,150),  
                        beta_A = 0,
                        beta_B = 0,
                        beta_AB = .25)
diagnoses_N <- diagnose_design(designs, sims = 1000, bootstrap = FALSE)
```

```{r, echo = FALSE}
if(exists("diagnoses_N")) {
diagnosands_N <- get_diagnosands(diagnoses_N) 
min_sample <- min(diagnosands_N$N[diagnosands_N$power>.8])
diagnosands_N %>% 
ggplot(
	aes(
		y = power, 
		x = N
	)
) +
geom_point(color = "#C67800") +
geom_smooth(se = FALSE, size = .5, color = "#205C8A", method = "loess") +
scale_y_continuous(name = "Power",limits = c(0,1.1),breaks = c(seq(0,1,.25),.8),minor_breaks = NULL) +
scale_x_continuous(name = "N",breaks = c(500,1000,1500,2000,min_sample,2500,3000), 
labels =  c(500,1000,1500,2000,paste0("\n",min_sample),2500,3000)
) + 
geom_hline(yintercept = .8,size = .1) +
geom_vline(xintercept = min_sample,size = .1) +
   theme_bw() +
      theme(
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank(),
        panel.grid.major = element_line(color = '#eeeeee'),
        strip.background = element_blank(),
        legend.position = "bottom",
        text = element_text(family = "Helvetica")
        )
}
```


## Further Reading

Factorial designs are used in all kinds of diverse contexts, consider these two for example:

 - See @blattman2017reducing for a factorial design that sought to test the theory that giving cash to criminally-engaged men in Uganda would produce a bigger reduction in their subsequent criminal behavior if it was coupled with cognitive behavioral therapy. The authors reasoned that cash windfalls would be especially likely to shift those with high business ability to non-criminal careers where those abilities were comparatively more valuable, and that therapy would increase business ability.
 
 - @kalla2015editorial used a factorial design to study bias in the way that political information is published and edited on Wikipedia. They randomly assigned the web pages of 251 US Senators to have one of four conditions: a positive fact added to the article, with a citation; a negative fact added, with citation; a positive without citation and finally a negative without citation. 

## Exercises

1. Alter the template so that outcomes are binary instead of normally distributed. What is the expected standard error for the interaction term for a sample size of 1000? Discuss the implications of your diagnosis for practice.

2. Assess how the power of the study to detect the interaction term varies as a function of the size and direction of the main effects of $A$ and $B$.

3. Find the minimal sample size needed to achieve 90% power with an interaction effect of 1/10th of a standard deviation, setting the main effects to zero.


## References {-}





























