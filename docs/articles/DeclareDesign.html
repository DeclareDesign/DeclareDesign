<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Diagnosing Research Designs with DeclareDesign • DeclareDesign</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">DeclareDesign</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/DeclareDesign.html">Getting Started</a>
</li>
<li>
  <a href="../reference/">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="https://declaredesign.org">DeclareDesign</a>
    </li>
    <li>
      <a href="http://randomizr.declaredesign.org">randomizr</a>
    </li>
    <li>
      <a href="http://fabricatr.declaredesign.org">fabricatr</a>
    </li>
    <li>
      <a href="http://estimatr.declaredesign.org">estimatr</a>
    </li>
  </ul>
</li>
<li>
  <a href="http://discuss.declaredesign.org">Discussion Board</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/DeclareDesign/DeclareDesign">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Diagnosing Research Designs with DeclareDesign</h1>
                        <h4 class="author">Graeme Blair, Jasper Cooper, Alexander Coppock, and Macartan Humphreys</h4>
            
            <h4 class="date">2017-07-22</h4>
          </div>

    
    
<div class="contents">
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>The <code>DeclareDesign</code> package has only about 10 functions.</p>
<p>The core functions represent key steps in a research design, some of which may be used more than once, such as if you have two random assignment steps or multiple estimators.</p>
<ol style="list-style-type: decimal">
<li><code>declare_population</code></li>
<li><code>declare_potential_outcomes</code></li>
<li><code>declare_sampling</code></li>
<li><code>declare_assignment</code></li>
<li><code>declare_estimand</code></li>
<li><code>declare_estimator</code></li>
</ol>
<p>The function <code>declare_design</code> can take any of these six functions, plus any R function that takes data and returns data.</p>
<p>The post-design-declaration commands are:</p>
<ol style="list-style-type: decimal">
<li>
<code>modify_design</code> (takes a design and a set of modifications, returns a design)</li>
<li>
<code>diagnose_design</code> (takes a design, returns simulations and diagnosis)</li>
<li>
<code>compare_designs</code> (takes a list of designs and diagnoses them all)</li>
<li>
<code>draw_data</code> (takes a design and returns a single draw of the data)</li>
<li>
<code>get_estimates</code>(takes a design a returns a single simulation of estimates)</li>
<li>
<code>get_estimands</code>(takes a design a returns a single simulation of estimands)</li>
</ol>
<p>There are a few other features:</p>
<ol style="list-style-type: decimal">
<li>A template is a function that takes parameters (e.g., <code>N</code>) and returns a design. <code>quick_design</code> is a function of a template and parameters that returns a design.</li>
<li>We can easily <code>declare_diagnosands</code>, which are things like power and bias, but the package defaults to the usual suspects.</li>
<li>
<code>reveal_outcomes</code> implements a general switching equation, which allows you to reveal outcomes from potential outcomes and a treatment assignment.</li>
</ol>
</div>
<div id="the-six-steps" class="section level1">
<h1 class="hasAnchor">
<a href="#the-six-steps" class="anchor"></a>The Six Steps</h1>
<p>Each of the <code>declare_*</code> functions returns a <strong>function</strong>.</p>
<p>In addition to using them to declare the design, you can just run them yourself, i.e. <code>your_potential_outcomes(your_population())</code>.</p>
<div id="population" class="section level2">
<h2 class="hasAnchor">
<a href="#population" class="anchor"></a>Population</h2>
<p>You can easily define a single-level population (i.e. just individuals). You can use any R function to create a variable, with <code>N</code> being the only privileged name. The output is a function, so calling <code>my_population()</code> makes a data.frame.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_population &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(<span class="dt">N =</span> <span class="dv">1000</span>,
  <span class="dt">income =</span> <span class="kw">rnorm</span>(N),
  <span class="dt">age =</span> <span class="kw">sample</span>(<span class="dv">18</span>:<span class="dv">95</span>, N, <span class="dt">replace =</span> T))

pop &lt;-<span class="st"> </span><span class="kw">my_population</span>()
<span class="kw">head</span>(pop)</code></pre></div>
<pre><code>##     ID     income age
## 1 0001 -1.0134549  66
## 2 0002 -1.1455315  29
## 3 0003  0.2767489  50
## 4 0004  1.4634655  43
## 5 0005  1.5898646  48
## 6 0006  0.7600144  41</code></pre>
<p>Multi-level datasets are also easy to use. You set the <code>N</code> of each level in a call to <code>level()</code>. The <code>level</code> function is neat – if the previous level has data, it merges so that there are N entries for each of the units at the higher level. We can handle non-fixed number of units at each level too. In the <code>individuals</code> line, we’ve drawn a random number of individuals that are in each village.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_population_nested &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(
  <span class="dt">districts =</span> <span class="kw">level</span>(<span class="dt">N =</span> <span class="dv">25</span>, <span class="dt">urban =</span> <span class="kw">sample</span>(<span class="dv">0</span>:<span class="dv">1</span>, N, <span class="dt">replace =</span> <span class="ot">TRUE</span>)),
  <span class="dt">villages =</span> <span class="kw">level</span>(<span class="dt">N =</span> <span class="dv">10</span>, <span class="dt">altitude =</span> <span class="kw">rnorm</span>(N)),
  <span class="dt">individuals =</span> <span class="kw">level</span>(<span class="dt">N =</span> <span class="kw">sample</span>(<span class="dv">100</span>:<span class="dv">200</span>, <span class="dt">size =</span> <span class="dv">250</span>, <span class="dt">replace =</span> <span class="ot">TRUE</span>), 
                      <span class="dt">income =</span> <span class="kw">rnorm</span>(N),
                      <span class="dt">age =</span> <span class="kw">sample</span>(<span class="dv">18</span>:<span class="dv">95</span>, N, <span class="dt">replace =</span> <span class="ot">TRUE</span>)))</code></pre></div>
<p>This says that there are 25 districts, 10 villages per districts, and then between 100 and 200 individuals per village. It creates districts first, then merges in villages, then merges in individuals using ID variables created at the level above it.</p>
<p>Within those levels, you can easily include existing data (and also add variables to them if you wish):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">region_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">capital =</span> <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>))
pop_level_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(
  <span class="dt">regions =</span> <span class="kw">level</span>(<span class="dt">level_data =</span> region_data, <span class="dt">gdp =</span> <span class="kw">runif</span>(<span class="dv">5</span>)),
  <span class="dt">cities =</span> <span class="kw">level</span>(<span class="dt">N =</span> <span class="dv">2</span>, <span class="dt">subways =</span> <span class="kw">rnorm</span>(N, <span class="dt">mean =</span> <span class="dv">5</span>)))

<span class="kw">head</span>(<span class="kw">pop_level_data</span>())</code></pre></div>
<pre><code>##   capital regions       gdp cities  subways
## 1       1       1 0.5552097     01 6.031948
## 2       1       1 0.5552097     02 7.397766
## 3       0       2 0.7320341     03 4.406440
## 4       0       2 0.7320341     04 5.297014
## 5       0       3 0.9642097     05 2.745528
## 6       0       3 0.9642097     06 4.706986</code></pre>
<p>Similarly, you can easily declare your existing data as the population:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">country_data &lt;-<span class="st"> </span><span class="kw">data.frame</span>(
  <span class="dt">cow_code =</span> <span class="kw">c</span>(<span class="dv">504</span>, <span class="dv">15</span>, <span class="dv">100</span>, <span class="dv">90</span>),
  <span class="dt">polity_iv =</span> <span class="kw">c</span>(-<span class="dv">9</span>, <span class="dv">7</span>, -<span class="dv">1</span>, <span class="dv">3</span>))
pop_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(<span class="dt">data =</span> country_data)

<span class="kw">head</span>(<span class="kw">pop_data</span>())</code></pre></div>
<pre><code>##   cow_code polity_iv ID
## 1      504        -9  1
## 2       15         7  2
## 3      100        -1  3
## 4       90         3  4</code></pre>
<p>If you don’t want your data to be fixed, you can resample from it, i.e.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">pop_data_bootstrap &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(
  <span class="dt">data =</span> country_data, <span class="dt">population_function =</span> fabricatr::resample_data)

<span class="kw">head</span>(<span class="kw">pop_data_bootstrap</span>())</code></pre></div>
<pre><code>##   cow_code polity_iv
## 1       15         7
## 2       15         7
## 3      504        -9
## 4       15         7</code></pre>
<p>Note that <code>fabricatr</code> is one of the helper packages that come along with <code>DeclareDesign</code>. <code>fabricatr</code> helps you simulate population data or resample from existing data.</p>
</div>
<div id="potential-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#potential-outcomes" class="anchor"></a>Potential outcomes</h2>
<p>A <code>declare_potential_outcomes</code> declaration returns a function. That function takes data and returns data with potential outcomes columns appended. There are two ways of declaring potential outcomes: a formula or as separate variables (as in <code>declare_population</code>).</p>
<div id="in-a-formula" class="section level3">
<h3 class="hasAnchor">
<a href="#in-a-formula" class="anchor"></a>In a formula</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_potential_outcomes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
  <span class="dt">formula =</span> Y ~<span class="st"> </span>.<span class="dv">25</span> *<span class="st"> </span>Z +<span class="st"> </span>.<span class="dv">01</span> *<span class="st"> </span>age *<span class="st"> </span>Z)
pop_pos &lt;-<span class="st"> </span><span class="kw">my_potential_outcomes</span>(pop)
<span class="kw">head</span>(pop_pos)</code></pre></div>
<pre><code>##     ID     income age Y_Z_0 Y_Z_1
## 1 0001 -1.0134549  66     0  0.91
## 2 0002 -1.1455315  29     0  0.54
## 3 0003  0.2767489  50     0  0.75
## 4 0004  1.4634655  43     0  0.68
## 5 0005  1.5898646  48     0  0.73
## 6 0006  0.7600144  41     0  0.66</code></pre>
<p>This has defaults set for condition_names (0, 1) and the assignment variable name (Z). You can set the “domain” of the potential outcomes function with <code>condition_names</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_potential_outcomes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
  <span class="dt">formula =</span> Y ~<span class="st"> </span>.<span class="dv">25</span> *<span class="st"> </span>Z +<span class="st"> </span>.<span class="dv">01</span> *<span class="st"> </span>age *<span class="st"> </span>Z,
  <span class="dt">condition_names =</span> <span class="dv">1</span>:<span class="dv">4</span>)
<span class="kw">head</span>(<span class="kw">my_potential_outcomes</span>(pop))</code></pre></div>
<pre><code>##     ID     income age Y_Z_1 Y_Z_2 Y_Z_3 Y_Z_4
## 1 0001 -1.0134549  66  0.91  1.82  2.73  3.64
## 2 0002 -1.1455315  29  0.54  1.08  1.62  2.16
## 3 0003  0.2767489  50  0.75  1.50  2.25  3.00
## 4 0004  1.4634655  43  0.68  1.36  2.04  2.72
## 5 0005  1.5898646  48  0.73  1.46  2.19  2.92
## 6 0006  0.7600144  41  0.66  1.32  1.98  2.64</code></pre>
</div>
<div id="as-separate-variables" class="section level3">
<h3 class="hasAnchor">
<a href="#as-separate-variables" class="anchor"></a>As separate variables</h3>
<p>The second way, which some may prefer, is to define each potential outcome yourself. This bakes in the condition names and assignment variable.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_potential_outcomes &lt;-
<span class="st">  </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
    <span class="dt">Y_Z_0 =</span> .<span class="dv">05</span>,
    <span class="dt">Y_Z_1 =</span> .<span class="dv">30</span> +<span class="st"> </span>.<span class="dv">01</span> *<span class="st"> </span>age)

<span class="kw">head</span>(<span class="kw">my_potential_outcomes</span>(pop))</code></pre></div>
<pre><code>##     ID     income age Y_Z_0 Y_Z_1
## 1 0001 -1.0134549  66  0.05  0.96
## 2 0002 -1.1455315  29  0.05  0.59
## 3 0003  0.2767489  50  0.05  0.80
## 4 0004  1.4634655  43  0.05  0.73
## 5 0005  1.5898646  48  0.05  0.78
## 6 0006  0.7600144  41  0.05  0.71</code></pre>
</div>
</div>
<div id="sampling" class="section level2">
<h2 class="hasAnchor">
<a href="#sampling" class="anchor"></a>Sampling</h2>
<p>A sampling function takes data and returns a sampled subset of the data. By default, <code>declare_sampling</code> understands arguments passed to <code>...</code> as <code>randomizr</code> arguments, but it’s easy to supply your own function instead.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_sampling &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_sampling.html">declare_sampling</a></span>(<span class="dt">n =</span> <span class="dv">250</span>)
smp &lt;-<span class="st"> </span><span class="kw">my_sampling</span>(pop_pos)
<span class="kw">nrow</span>(smp)</code></pre></div>
<pre><code>## [1] 250</code></pre>
</div>
<div id="assignment" class="section level2">
<h2 class="hasAnchor">
<a href="#assignment" class="anchor"></a>Assignment</h2>
<p>Assignment declarations return functions of data that return data. If you use the <code>randomizr</code> defaults, then it appends to the dataset an assignment draw and a vector of observed probability weights.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_assignment &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_assignment.html">declare_assignment</a></span>(<span class="dt">m =</span> <span class="dv">25</span>)
smp &lt;-<span class="st"> </span><span class="kw">my_assignment</span>(smp)
<span class="kw">table</span>(smp$Z)</code></pre></div>
<pre><code>## 
##   0   1 
## 225  25</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(smp)</code></pre></div>
<pre><code>##      ID     income age Y_Z_0 Y_Z_1 S_inclusion_prob Z Z_cond_prob
## 2  0002 -1.1455315  29     0  0.54             0.25 0         0.9
## 7  0007 -0.4517131  29     0  0.54             0.25 0         0.9
## 8  0008 -2.4595391  38     0  0.63             0.25 0         0.9
## 10 0010 -0.6864108  31     0  0.56             0.25 0         0.9
## 12 0012 -0.4404616  73     0  0.98             0.25 0         0.9
## 19 0019  0.9004096  67     0  0.92             0.25 0         0.9</code></pre>
</div>
<div id="estimands" class="section level2">
<h2 class="hasAnchor">
<a href="#estimands" class="anchor"></a>Estimands</h2>
<p>Estimands run on data that includes potential outcomes, drawn earlier using a declare_potential_outcomes call.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_estimand &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_estimand.html">declare_estimand</a></span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Z_1 -<span class="st"> </span>Y_Z_0))
<span class="kw">my_estimand</span>(pop_pos)</code></pre></div>
<pre><code>##   estimand_label estimand
## 1            ATE   0.8128</code></pre>
<p>The only part baked in to <code>DeclareDesign</code> is the naming structure, outcome_assignment_condition. You could write your own potential outcomes function to avoid this (and in most cases this would also require writing your own reveal_outcomes function).</p>
</div>
<div id="estimators" class="section level2">
<h2 class="hasAnchor">
<a href="#estimators" class="anchor"></a>Estimators</h2>
<p>To declare an estimator, you declare an estimator function, a difference_in_means by default. Optionally you also declare an estimand that is attached to the estimator.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">smp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/reveal_outcomes.html">reveal_outcomes</a></span>(smp)
my_estimator_dim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_estimator.html">declare_estimator</a></span>(Y ~<span class="st"> </span>Z, <span class="dt">estimand =</span> my_estimand)
<span class="kw">my_estimator_dim</span>(smp)</code></pre></div>
<pre><code>##   estimator_label    est         se            p  ci_lower  ci_upper  df
## 1    my_estimator 0.7692 0.05269383 2.969653e-35 0.6654155 0.8729845 248
##   estimand_label
## 1            ATE</code></pre>
<p>Using our simple <code>lm</code> function with built-in robust standard errors (HC2! or your choice of other HC’s) is similarly straightforward (it’s also fast! in RCPP!).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_estimator_lm &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/declare_estimator.html">declare_estimator</a></span>(Y ~<span class="st"> </span>Z, 
                    <span class="dt">estimator_function =</span> estimatr::lm_robust_se, 
                    <span class="dt">coefficient_name =</span> <span class="st">"Z"</span>, 
                    <span class="dt">estimand =</span> my_estimand)

<span class="kw">my_estimator_lm</span>(smp)</code></pre></div>
<pre><code>##   estimator_label variable_names    est         se            p  ci_lower
## 2    my_estimator              Z 0.7692 0.05269383 2.969653e-35 0.6654155
##    ci_upper estimand_label
## 2 0.8729845            ATE</code></pre>
</div>
</div>
<div id="declaring-designs" class="section level1">
<h1 class="hasAnchor">
<a href="#declaring-designs" class="anchor"></a>Declaring Designs</h1>
<p>Instead of defining your population, potential outcomes, and so on, you simply give us a set of functions in the order of your DAG, i.e. beginning with a population, then potential outcomes, sampling, and so on. You can also put any <code>R</code> function in causal order that takes data and returns data – including all the nice functions in <code>dplyr</code> like <code>mutate</code>, to allow you to create new variables and do things like collapse clusters</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">design &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_design.html">declare_design</a></span>(my_population,
                         my_potential_outcomes,
                         my_estimand,
                         dplyr::<span class="kw">mutate</span>(<span class="dt">big_income =</span> <span class="dv">5</span>*income), 
                         my_sampling,
                         my_assignment,
                         reveal_outcomes,
                         my_estimator_dim)</code></pre></div>
<p>Remarks re: <code>declare_design</code>:</p>
<ol style="list-style-type: decimal">
<li>The first argument must always be a dataset or create one.</li>
<li>Your estimand is placed where you want to define it, i.e. here we are defining a PATE by placing the estimand just after population and before sampling or assignment.</li>
<li>
<code>declare_design</code> produces two things: a “dgp function” and a “design function.” The dgp function draws a dataset and the design function returns an estimands dataframe and an estimates data frame. It simulates the design from population through estimates, in whatever order you tell it – meaning it carefully separates the data generating parts of the design and the calculation of estimates and estimands.</li>
</ol>
<p>You can run them directly via:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">dat &lt;-<span class="st"> </span><span class="kw"><a href="../reference/draw_data.html">draw_data</a></span>(design)
<span class="kw">head</span>(dat)</code></pre></div>
<pre><code>##      ID      income age Y_Z_0 Y_Z_1  big_income S_inclusion_prob Z
## 1  0001  0.42449772  53  0.05  0.83   2.1224886             0.25 0
## 12 0012  0.69705775  39  0.05  0.69   3.4852887             0.25 0
## 20 0020  0.05887295  91  0.05  1.21   0.2943648             0.25 0
## 25 0025  0.45242236  54  0.05  0.84   2.2621118             0.25 0
## 27 0027 -2.17656938  86  0.05  1.16 -10.8828469             0.25 0
## 30 0030  2.46178808  45  0.05  0.75  12.3089404             0.25 0
##    Z_cond_prob    Y
## 1          0.9 0.05
## 12         0.9 0.05
## 20         0.9 0.05
## 25         0.9 0.05
## 27         0.9 0.05
## 30         0.9 0.05</code></pre>
<p>and</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_estimates.html">get_estimates</a></span>(design)</code></pre></div>
<pre><code>##   estimator_label    est         se            p  ci_lower  ci_upper  df
## 1    my_estimator 0.8256 0.04368478 5.977113e-50 0.7395595 0.9116405 248
##   estimand_label
## 1            ATE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/get_estimands.html">get_estimands</a></span>(design)</code></pre></div>
<pre><code>##   estimand_label estimand
## 1            ATE  0.82079</code></pre>
</div>
<div id="custom-functions" class="section level1">
<h1 class="hasAnchor">
<a href="#custom-functions" class="anchor"></a>Custom functions</h1>
<p>Because all steps are functions, it’s easy for you to provide custom functions instead of using our defaults.</p>
<div id="custom-population" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-population" class="anchor"></a>Custom Population</h2>
<p>You can use a custom function to generate your population entirely on your own, too:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_population_function &lt;-<span class="st"> </span>function(N) {
  <span class="kw">data.frame</span>(<span class="dt">u =</span> <span class="kw">rnorm</span>(N))
}

my_population_custom &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(
  <span class="dt">population_function =</span> my_population_function, <span class="dt">N =</span> <span class="dv">100</span>)

pop_custom &lt;-<span class="st"> </span><span class="kw">my_population_custom</span>()

<span class="kw">head</span>(pop_custom)</code></pre></div>
<pre><code>##             u
## 1  0.68661989
## 2  1.64826918
## 3  0.01744842
## 4  0.71065070
## 5 -0.51228808
## 6  0.63300474</code></pre>
</div>
<div id="custom-potential-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-potential-outcomes" class="anchor"></a>Custom Potential Outcomes</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_potential_outcomes_function &lt;-
<span class="st">  </span>function(data) {
    data$Y_Z_0 &lt;-<span class="st"> </span><span class="kw">with</span>(data, u)
    data$Y_Z_1 &lt;-<span class="st"> </span><span class="kw">with</span>(data, <span class="fl">0.25</span> +<span class="st"> </span>u)
    data
  }
my_potential_outcomes_custom &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
  <span class="dt">potential_outcomes_function =</span> my_potential_outcomes_function
)

pop_pos_custom &lt;-<span class="st"> </span><span class="kw">my_potential_outcomes_custom</span>(pop_custom)

<span class="kw">head</span>(pop_pos_custom[, <span class="kw">c</span>(<span class="st">"u"</span>, <span class="st">"Y_Z_0"</span>, <span class="st">"Y_Z_1"</span>)])</code></pre></div>
<pre><code>##             u       Y_Z_0      Y_Z_1
## 1  0.68661989  0.68661989  0.9366199
## 2  1.64826918  1.64826918  1.8982692
## 3  0.01744842  0.01744842  0.2674484
## 4  0.71065070  0.71065070  0.9606507
## 5 -0.51228808 -0.51228808 -0.2622881
## 6  0.63300474  0.63300474  0.8830047</code></pre>
</div>
<div id="custom-sampling" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-sampling" class="anchor"></a>Custom Sampling</h2>
<p>Again, you can still use a totally separate custom sampling function easily. In this case, you are asked to provide a function that takes population data and returns sampled data, i.e. you draw the sample and then subset. You can also include inclusion weights if you wish in the function (as the default function does).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_sampling_function &lt;-<span class="st"> </span>function(data) {
     data$S &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dt">n =</span> <span class="kw">nrow</span>(data),
            <span class="dt">size =</span> <span class="dv">1</span>,
            <span class="dt">prob =</span> <span class="fl">0.1</span>)
     data[data$S ==<span class="st"> </span><span class="dv">1</span>, ]
}

my_sampling_custom &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_sampling.html">declare_sampling</a></span>(
  <span class="dt">sampling_function =</span> my_sampling_function)

smp_custom &lt;-<span class="st"> </span><span class="kw">my_sampling_custom</span>(pop_pos)

<span class="kw">nrow</span>(smp_custom)</code></pre></div>
<pre><code>## [1] 89</code></pre>
</div>
<div id="custom-assignment" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-assignment" class="anchor"></a>Custom Assignment</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_assignment_function &lt;-<span class="st"> </span>function(data) {
  data$Z &lt;-<span class="st"> </span><span class="kw">rbinom</span>(<span class="dt">n =</span> <span class="kw">nrow</span>(data),
         <span class="dt">size =</span> <span class="dv">1</span>,
         <span class="dt">prob =</span> <span class="fl">0.5</span>)
  data
}
my_assignment_custom &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_assignment.html">declare_assignment</a></span>(
  <span class="dt">assignment_function =</span> my_assignment_function)

<span class="kw">table</span>(<span class="kw">my_assignment_custom</span>(pop_pos)$Z)</code></pre></div>
<pre><code>## 
##   0   1 
## 477 523</code></pre>
</div>
<div id="custom-estimand" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-estimand" class="anchor"></a>Custom Estimand</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_estimand_function &lt;-<span class="st"> </span>function(data) {
  <span class="kw">with</span>(data, <span class="kw">median</span>(Y_Z_1 -<span class="st"> </span>Y_Z_0))
}
my_estimand_custom &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_estimand.html">declare_estimand</a></span>(
  <span class="dt">estimand_function =</span> my_estimand_function, <span class="dt">label =</span> medianTE)

<span class="kw">my_estimand_custom</span>(pop_pos)</code></pre></div>
<pre><code>##   estimand_label estimand
## 1       medianTE     0.81</code></pre>
</div>
<div id="custom-estimator" class="section level2">
<h2 class="hasAnchor">
<a href="#custom-estimator" class="anchor"></a>Custom Estimator</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_estimator_function &lt;-<span class="st"> </span>function(formula, data){
  <span class="kw">data.frame</span>(<span class="dt">est =</span> <span class="kw">with</span>(data, <span class="kw">mean</span>(Y)))
}

my_estimator_custom &lt;-<span class="st"> </span>
<span class="st">  </span><span class="kw"><a href="../reference/declare_estimator.html">declare_estimator</a></span>(Y ~<span class="st"> </span>Z, 
                    <span class="dt">estimator_function =</span> my_estimator_function, 
                    <span class="dt">estimand =</span> my_estimand)

<span class="kw">my_estimator_custom</span>(smp)</code></pre></div>
<pre><code>##   estimator_label     est estimand_label
## 1    my_estimator 0.07692            ATE</code></pre>
</div>
</div>
<div id="features" class="section level1">
<h1 class="hasAnchor">
<a href="#features" class="anchor"></a>Features</h1>
<div id="quick-design" class="section level2">
<h2 class="hasAnchor">
<a href="#quick-design" class="anchor"></a>Quick design</h2>
<p>You can also write a design maker function that declares a design based on a set of parameters like N, the number of clusters, etc. and use the function <code>quick_design</code> to make designs using just those parameters.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">m_arm_trial &lt;-<span class="st"> </span>function(numb){
  my_population &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(
    <span class="dt">N =</span> numb, <span class="dt">income =</span> <span class="kw">rnorm</span>(N), <span class="dt">age =</span> <span class="kw">sample</span>(<span class="dv">18</span>:<span class="dv">95</span>, N, <span class="dt">replace =</span> T))

  my_potential_outcomes &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
    <span class="dt">formula =</span> Y ~<span class="st"> </span>.<span class="dv">25</span> *<span class="st"> </span>Z +<span class="st"> </span>.<span class="dv">01</span> *<span class="st"> </span>age *<span class="st"> </span>Z)
  my_sampling &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_sampling.html">declare_sampling</a></span>(<span class="dt">n =</span> <span class="dv">250</span>)
  my_assignment &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_assignment.html">declare_assignment</a></span>(<span class="dt">m =</span> <span class="dv">25</span>)
  my_estimand &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_estimand.html">declare_estimand</a></span>(<span class="dt">ATE =</span> <span class="kw">mean</span>(Y_Z_1 -<span class="st"> </span>Y_Z_0))
  my_estimator_dim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_estimator.html">declare_estimator</a></span>(Y ~<span class="st"> </span>Z, <span class="dt">estimand =</span> my_estimand)
  my_design &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_design.html">declare_design</a></span>(my_population,
                              my_potential_outcomes,
                              my_estimand,
                              my_sampling,
                              my_assignment,
                              reveal_outcomes,
                              my_estimator_dim)
  <span class="kw">return</span>(my_design)
}

my_1000_design &lt;-<span class="st"> </span><span class="kw"><a href="../reference/quick_design.html">quick_design</a></span>(<span class="dt">template =</span> m_arm_trial, <span class="dt">numb =</span> <span class="dv">1000</span>)
<span class="kw">head</span>(<span class="kw"><a href="../reference/draw_data.html">draw_data</a></span>(my_1000_design))</code></pre></div>
<pre><code>##      ID     income age Y_Z_0 Y_Z_1 S_inclusion_prob Z Z_cond_prob    Y
## 2  0002 -2.2377323  74     0  0.99             0.25 0         0.9 0.00
## 9  0009 -2.4532134  25     0  0.50             0.25 0         0.9 0.00
## 10 0010 -0.2653166  50     0  0.75             0.25 1         0.1 0.75
## 12 0012 -0.9094961  20     0  0.45             0.25 0         0.9 0.00
## 13 0013 -1.4684470  43     0  0.68             0.25 0         0.9 0.00
## 17 0017  0.7146283  38     0  0.63             0.25 0         0.9 0.00</code></pre>
</div>
<div id="continuous-potential-outcomes" class="section level2">
<h2 class="hasAnchor">
<a href="#continuous-potential-outcomes" class="anchor"></a>Continuous potential outcomes</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_potential_outcomes_continuous &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
  <span class="dt">formula =</span> Y ~<span class="st"> </span>.<span class="dv">25</span> *<span class="st"> </span>Z +<span class="st"> </span>.<span class="dv">01</span> *<span class="st"> </span>age *<span class="st"> </span>Z, <span class="dt">condition_names =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> .<span class="dv">1</span>))

continuous_treatment_function &lt;-<span class="st"> </span>function(data){
 data$Z &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">by =</span> .<span class="dv">1</span>), <span class="dt">size =</span> <span class="kw">nrow</span>(data), <span class="dt">replace =</span> <span class="ot">TRUE</span>)
 data
}

my_assignment_continuous &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_assignment.html">declare_assignment</a></span>(<span class="dt">assignment_function =</span> continuous_treatment_function)

my_design &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_design.html">declare_design</a></span>(<span class="kw">my_population</span>(),
                            my_potential_outcomes_continuous,
                            my_assignment_continuous,
                            reveal_outcomes)

<span class="kw">head</span>(<span class="kw"><a href="../reference/draw_data.html">draw_data</a></span>(my_design))</code></pre></div>
<pre><code>##     ID       income age Y_Z_0 Y_Z_0.1 Y_Z_0.2 Y_Z_0.3 Y_Z_0.4 Y_Z_0.5
## 1 0001 -0.003388557  18     0   0.043   0.086   0.129   0.172   0.215
## 2 0002  0.831896277  73     0   0.098   0.196   0.294   0.392   0.490
## 3 0003  0.702331966  22     0   0.047   0.094   0.141   0.188   0.235
## 4 0004 -0.838640700  71     0   0.096   0.192   0.288   0.384   0.480
## 5 0005 -1.386823743  28     0   0.053   0.106   0.159   0.212   0.265
## 6 0006  1.123572693  75     0   0.100   0.200   0.300   0.400   0.500
##   Y_Z_0.6 Y_Z_0.7 Y_Z_0.8 Y_Z_0.9 Y_Z_1   Z     Y
## 1   0.258   0.301   0.344   0.387  0.43 0.3 0.129
## 2   0.588   0.686   0.784   0.882  0.98 0.3 0.294
## 3   0.282   0.329   0.376   0.423  0.47 0.4 0.188
## 4   0.576   0.672   0.768   0.864  0.96 0.6 0.576
## 5   0.318   0.371   0.424   0.477  0.53 0.7 0.371
## 6   0.600   0.700   0.800   0.900  1.00 0.6 0.600</code></pre>
</div>
<div id="attrition" class="section level2">
<h2 class="hasAnchor">
<a href="#attrition" class="anchor"></a>Attrition</h2>
<p>Just another potential outcome!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">my_potential_outcomes_attrition &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_potential_outcomes.html">declare_potential_outcomes</a></span>(
  <span class="dt">formula =</span> R ~<span class="st"> </span><span class="kw">rbinom</span>(<span class="dt">n =</span> N, <span class="dt">size =</span> <span class="dv">1</span>, <span class="dt">prob =</span> <span class="kw">pnorm</span>(Y_Z_0)))

my_design &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_design.html">declare_design</a></span>(<span class="kw">my_population</span>(),
                            my_potential_outcomes,
                            my_potential_outcomes_attrition,
                            my_assignment,
                            <span class="kw"><a href="../reference/reveal_outcomes.html">reveal_outcomes</a></span>(<span class="dt">outcome_variable_name =</span> <span class="st">"R"</span>),
                            <span class="kw"><a href="../reference/reveal_outcomes.html">reveal_outcomes</a></span>(<span class="dt">attrition_variable_name =</span> <span class="st">"R"</span>))

<span class="kw">head</span>(<span class="kw"><a href="../reference/draw_data.html">draw_data</a></span>(my_design)[, <span class="kw">c</span>(<span class="st">"ID"</span>, <span class="st">"Y_Z_0"</span>, <span class="st">"Y_Z_1"</span>, <span class="st">"R_Z_0"</span>, <span class="st">"R_Z_1"</span>, <span class="st">"Z"</span>, <span class="st">"R"</span>, <span class="st">"Y"</span>)])</code></pre></div>
<pre><code>##     ID Y_Z_0 Y_Z_1 R_Z_0 R_Z_1 Z R    Y
## 1 0001  0.05  0.91     1     1 0 1 0.05
## 2 0002  0.05  1.16     0     1 0 0   NA
## 3 0003  0.05  1.09     1     0 0 1 0.05
## 4 0004  0.05  0.61     0     0 0 0   NA
## 5 0005  0.05  0.68     1     1 0 1 0.05
## 6 0006  0.05  1.18     0     1 0 0   NA</code></pre>
</div>
<div id="stochastic-population-sizes" class="section level2">
<h2 class="hasAnchor">
<a href="#stochastic-population-sizes" class="anchor"></a>Stochastic population sizes</h2>
<p>The population (or any level of the population) can have stochastic population sizes. (In fact, N can be a number, a fixed vector of numbers, or an expression that returns a stochastic number or vector of numbers.)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">stochastic_population &lt;-<span class="st"> </span><span class="kw"><a href="../reference/declare_population.html">declare_population</a></span>(
  <span class="dt">N =</span> <span class="kw">sample</span>(<span class="dv">500</span>:<span class="dv">1000</span>, <span class="dv">1</span>), <span class="dt">income =</span> <span class="kw">rnorm</span>(N), <span class="dt">age =</span> <span class="kw">sample</span>(<span class="dv">18</span>:<span class="dv">95</span>, N, <span class="dt">replace =</span> <span class="ot">TRUE</span>))

<span class="kw">c</span>(<span class="kw">nrow</span>(<span class="kw">stochastic_population</span>()), 
  <span class="kw">nrow</span>(<span class="kw">stochastic_population</span>()), 
  <span class="kw">nrow</span>(<span class="kw">stochastic_population</span>()))</code></pre></div>
<pre><code>## [1] 899 566 799</code></pre>
</div>
</div>
<div id="three-companion-packages" class="section level1">
<h1 class="hasAnchor">
<a href="#three-companion-packages" class="anchor"></a>Three companion packages</h1>
<p>All built-in default functions are in three standalone packages that can be used to support DeclareDesign or on their own. This enables the simplicity of the six key functions in <code>declare_design</code> and a minimal number of dependencies.</p>
<p>For now, make sure you have the development versions of each package from Github, not the version of randomizr on CRAN.</p>
<p>The three packages are:</p>
<div id="fabricatr" class="section level2">
<h2 class="hasAnchor">
<a href="#fabricatr" class="anchor"></a><code>fabricatr</code>
</h2>
<p><code>fabricatr</code>, includes data creation features described above. It’s main function, <code>fabricate_data</code>, creates simulated data as in the above examples in <code>declare_population</code>. It can do single level data creation or multilevel creation using <code>level()</code> within <code>fabricate_data</code>. As it turns out, it is also the backbone of <code>declare_potential_outcomes</code> default function that creates each PO as an expression described above (i.e. where you define <code>Y_Z_1 = 0.5 + Z</code>). The second main function is <code>bootstrap_data</code> which resamples your data in a way that respects hierarchy. We expect this package will be built up further, including with proportional outcomes functions.</p>
</div>
<div id="randomizr" class="section level2">
<h2 class="hasAnchor">
<a href="#randomizr" class="anchor"></a><code>randomizr</code>
</h2>
<p><code>randomizr</code> works by default as described above in <code><a href="../reference/declare_assignment.html">declare_assignment()</a></code> – in fact appears to the user similarly to the old version – but is entirely separate now. The set of sampling functions that mimic the assignment functions are now also built in to <code>randomizr</code>, including simple, clustered, stratified, and clustered-and-stratified sampling. The next step is to rewrite some of these into C++ to see if we can speed a few of them up. Based on our understanding of Rcpp, the speedup gains here may be minor.</p>
</div>
<div id="estimatr" class="section level2">
<h2 class="hasAnchor">
<a href="#estimatr" class="anchor"></a><code>estimatr</code>
</h2>
<p>The <code>C++</code> version of lm with robust standard errors described above as well as the difference-in-means and blocked difference-in-means functions are the core of <code>estimatr</code> now, but it can be built up with further fast estimators.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#overview">Overview</a></li>
      <li>
<a href="#the-six-steps">The Six Steps</a><ul class="nav nav-pills nav-stacked">
<li><a href="#population">Population</a></li>
      <li><a href="#potential-outcomes">Potential outcomes</a></li>
      <li><a href="#sampling">Sampling</a></li>
      <li><a href="#assignment">Assignment</a></li>
      <li><a href="#estimands">Estimands</a></li>
      <li><a href="#estimators">Estimators</a></li>
      </ul>
</li>
      <li><a href="#declaring-designs">Declaring Designs</a></li>
      <li>
<a href="#custom-functions">Custom functions</a><ul class="nav nav-pills nav-stacked">
<li><a href="#custom-population">Custom Population</a></li>
      <li><a href="#custom-potential-outcomes">Custom Potential Outcomes</a></li>
      <li><a href="#custom-sampling">Custom Sampling</a></li>
      <li><a href="#custom-assignment">Custom Assignment</a></li>
      <li><a href="#custom-estimand">Custom Estimand</a></li>
      <li><a href="#custom-estimator">Custom Estimator</a></li>
      </ul>
</li>
      <li>
<a href="#features">Features</a><ul class="nav nav-pills nav-stacked">
<li><a href="#quick-design">Quick design</a></li>
      <li><a href="#continuous-potential-outcomes">Continuous potential outcomes</a></li>
      <li><a href="#attrition">Attrition</a></li>
      <li><a href="#stochastic-population-sizes">Stochastic population sizes</a></li>
      </ul>
</li>
      <li>
<a href="#three-companion-packages">Three companion packages</a><ul class="nav nav-pills nav-stacked">
<li><a href="#fabricatr"><code>fabricatr</code></a></li>
      <li><a href="#randomizr"><code>randomizr</code></a></li>
      <li><a href="#estimatr"><code>estimatr</code></a></li>
      </ul>
</li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Graeme Blair, Jasper Cooper, Alexander Coppock, Macartan Humphreys.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
